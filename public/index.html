<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Titel</title>
    <link rel="stylesheet" href="styles.css">

    <script src="index.js" type="module" defer></script>
    <script>

        const calculateSubtotal = (r, wantedItem) => {

            let elSubtotal = r.querySelector('.product-subtotal');
            let elQuantity = r.querySelector('.product-quantity');

            elSubtotal.value = elQuantity.value * wantedItem;
            renderNewInput(showResults);
        }

        const showResults = evt => {
            
            inputField = evt.target;
            val = evt.target.value;
            //console.log(evt, evt.target, val);
            let neighbor = evt.target.parentNode;
            let root = evt.target.parentNode.parentNode;            
            let res = neighbor.querySelector('.result');
            
            let itemPrice = root.querySelector('.product-price');

            const selectItem = evt => {

                inputField.value = evt.target.innerText;
                itemPrice.value = wantedIndex;
                res.innerHTML = ``;
                calculateSubtotal(root, itemPrice.value);
            }

            res.innerHTML = '';
            if (val == '') {
                return;
            }
            let list = '';

            fetch('/suggest?q=' + val).then(
                response => {
                    return response.json();
                }).then(
                    data => {
                        for (let i = 0; i < data.length; i++) {
                            list += '<li class="suggestedItem">' + data[i].item[0] + '</li>';
                            wantedIndex = data[i].item[1];
                        }
                        res.innerHTML = '<ul>' + list + '</ul>';

                        const erg = [...(document.querySelectorAll('.suggestedItem'))];
                        for (let j = 0; j < erg.length; j++) {
                            let suggestedItem = erg[j];
                            suggestedItem.addEventListener('click', selectItem)
                        }

                        return true;
                    }
                ).catch(
                    err => {
                        console.warn('Something went wrong.', err);
                        return false;
                    }
                );
        }


    </script>

</head>

<body>

    <h1></h1>

    <div class="container">
        <form class="form">
            <!-- Logo missing -->
            <div class="company-data">
                <span class="company-name">YoTa Charms</span>
                <span class="company-adress">Kettenschmiede 7</span>
                <span class="company-location">32776 Ederhausen</span>
            </div>

            <!-- letter head -->
            <div class="letter-head">
                <div class="recipient-adress">
                    <div class="first-line">
                        <div class="form-item">
                            <label for="recipient-name" class="form-label"></label>
                            <input type="text" name="recipient-name" id="recipient-name" placeholder="name">
                            <span class="form-error"></span>
                        </div>
                        <div class="form-item">
                            <label for="recipient-last-name" class="form-label"></label>
                            <input type="text" name="recipient-last-name" id="recipient-last-name"
                                placeholder="last name">
                            <span class="form-error"></span>
                        </div>
                    </div>
                    <div class="second-line">
                        <div class="form-item">
                            <label for="recipient-road" class="form-label"></label>
                            <input type="text" name="recipient-road" id="recipient-road" placeholder="road">
                            <span class="form-error"></span>
                        </div>
                        <!-- Number.. maybe -->
                        <div class="form-item">
                            <label for="recipient-house-number" class="form-label"></label>
                            <input type="text" name="recipient-house-number" id="recipient-house-number"
                                placeholder="house number">
                            <span class="form-error"></span>
                        </div>
                    </div>
                    <div class="third-line">
                        <!-- Number -->
                        <div class="form-item">
                            <label for="recipient-zip-code" class="form-label"></label>
                            <input type="text" name="recipient-zip-code" id="recipient-zip-code" placeholder="zip code">
                            <span class="form-error"></span>
                        </div>
                        <div class="form-item">
                            <label for="recipient-city" class="form-label"></label>
                            <input type="text" name="recipient-city" id="recipient-city" placeholder="city">
                            <span class="form-error"></span>
                        </div>
                    </div>

                    <button type="submit" class="btnSave" name="btnSave">Save</button>

                </div>
            </div>

            <div>
                <span class="invoice-date"></span><br><br>
            </div>

            <!-- subject -->
            <div class="subject-line">
                <div class="left-hand">
                    <span class="invoice-title">Invoice</span>
                    <span class="invoice-id"></span>
                    <!-- fortlaufend -->
                </div>
                <div class="right-hand"><br><br><br>
                    <span class="customer-id"></span>
                    <!-- System Ã¼berlegen -->
                </div>
            </div>


        </form>
        <!-- purchase-overview -->
        <div class="legend">
            <span class="quantity">Quantity</span>
            <span class="item">Item</span>
            <span class="price">Price per Unit</span>
            <span class="subtotal">Subtotal</span>
        </div><br>
        <form class="listing" autocomplete="off">
            <div class="listings-item">

                <input type="number" name="product-quantity" class="product-quantity">
                <span class="quantity-error"></span>

                <div class="suggestion">
                    <input type="text" name="product-name" class="product-name"/>
                    <span class="result"></span>
                    <!-- Show Error -->
                </div>

                <input type="text" name="product-price" class="product-price">
                <input type="text" name="product-subtotal" class="product-subtotal">

            </div>


        </form><br><br>
        <!-- payment matters -->
        <div class="payment-matters">
            <div class="bank-details">
                <span class="bank-title">Bank details</span>
                <span class="IBAN">DE02120300000000202051</span>
                <span class="financial-institution">DKB</span>
            </div>
            <div class="invoice-due">
                <span class="due-title">Due by</span>
                <span class="due-date"></span>
            </div>
            <div class="invoice-total">
                <span class="total-title">Total</span>
                <!-- calculated by listed items -->
                <span class="total-amount"></span>
                <span class="taxes">includes 19% VAT</span>
            </div>
        </div>
        <span class="customer-relations">Thank you!</span>

        <!-- footer -->
        <div class="company-credentials">
            <div class="company-item">
                <span class="company-court">Amtsgericht</span>
                <span class="company-court-name">Amberg</span>
            </div>
            <div class="company-item">
                <span class="company-ust">USt-IdNr.</span>
                <span class="company-ust-name">DE999999999</span>
            </div>
            <div class="company-item">
                <span class="company-url">Website</span>
                <span class="company-url-name">www.yota-charms.com</span>
            </div>
        </div>
    </div>

    <button type="submit" class="btnCreate">Create PDF</button>


</body>

<script>

    let wantedIndex;
    const formListing = document.querySelector('.listing');
    let inputField = document.querySelector('.product-name');
    inputField.addEventListener('keyup', () => showResults(event));

    const renderNewInput = (callback) => {

        let listingsItem = document.createElement('div');
        listingsItem.className = 'listings-item';
        formListing.append(listingsItem);

        let elQuantity = document.createElement('input');
        elQuantity.type = 'number';
        elQuantity.name = 'product-quantity';
        elQuantity.className = 'product-quantity';
        listingsItem.append(elQuantity);

        let quantityError = document.createElement('span');
        quantityError.className = 'quantity-error';
        elQuantity.append(quantityError);

        let elSuggestion = document.createElement('div');
        elSuggestion.className = 'suggestion';
        listingsItem.append(elSuggestion);

        let elProduct = document.createElement('input');
        elProduct.type = 'text';
        elProduct.name = 'product-name';
        elProduct.className = 'product-name';
        elSuggestion.append(elProduct);
        elProduct.addEventListener('keyup', callback);

        let elResult = document.createElement('span');
        elResult.className = 'result';
        elSuggestion.append(elResult);

        let elPrice = document.createElement('input');
        elPrice.type = 'text';
        elPrice.name = 'product-price';
        elPrice.className = 'product-price';
        listingsItem.append(elPrice);

        let elSubtotal = document.createElement('input');
        elSubtotal.type = 'text';
        elSubtotal.name = 'subtotal';
        elSubtotal.className = 'subtotal';
        listingsItem.append(elSubtotal);

    }


    const $ = selector => {
        return document.querySelector(selector)
    }

    let customerId = $('.customer-id');
    const createNumber = (min, max) => ~~(Math.random() * (max - min + 1) + min);
    customerId.innerHTML = `Customer #${String(createNumber(10, 99)) + String(createNumber(10, 99)) + String(createNumber(10, 99))}`;

    let invoiceId = $('.invoice-id');
    invoiceId.innerHTML = '#' + '000' + `${387}`;

    let invoiceDate = $('.invoice-date');
    let date = new Date(), options = { year: 'numeric', month: 'long', day: 'numeric' };
    invoiceDate.innerHTML = date.toLocaleString('de-DE', options);

    let invoiceDue = $('.due-date');
    let iso = date.toISOString();
    let n = iso.split('T');
    let n1 = n[0];
    let x = new Date(new Date(n1).setDate(new Date(n1).getDate() + 30));
    invoiceDue.innerHTML = x.toLocaleString('de-DE', options);

    let invoiceTotal = $('.total-amount');


</script>

</html>